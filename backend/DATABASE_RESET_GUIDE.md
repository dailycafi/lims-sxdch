# 测试阶段数据库管理指南

## 快速重置数据库

在测试阶段，您可以随时完整重置数据库的**结构和内容**。

### 方法一：使用一键重置脚本（推荐）⭐

**Mac/Linux:**
```bash
cd backend
./reset_db.sh
```

**Windows:**
```bash
cd backend
reset_db.bat
```

这个脚本会自动完成：
1. ✅ 删除所有表并重建（包括新的角色权限表）
2. ✅ 重新创建测试数据
3. ✅ 初始化7个角色和35个权限
4. ✅ 为6个测试用户分配角色

**执行时间**: 约5-10秒

---

### 方法二：手动执行步骤

```bash
cd backend

# 步骤1: 重建数据库（删除所有表和数据）
python init_db.py --drop

# 步骤2: 初始化角色权限
python init_roles.py

# 步骤3: 迁移用户角色
python migrate_user_roles.py
```

---

## 重置后的状态

### 数据库表
- ✅ **users** - 用户表（6个测试用户）
- ✅ **roles** - 角色表（7个系统角色）
- ✅ **permissions** - 权限表（35个权限）
- ✅ **user_roles** - 用户角色关联表
- ✅ **role_permissions** - 角色权限关联表
- ✅ **projects** - 项目表（测试数据）
- ✅ **samples** - 样本表（测试数据）
- ✅ **organizations** - 组织表（测试数据）
- ✅ **sample_types** - 样本类型表（测试数据）
- ✅ **storage_freezers** - 存储设备表（测试数据）
- ✅ 其他相关表...

### 测试账号（6个）

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 系统管理员 | 所有权限 |
| sample_admin | sample123 | 样本管理员 | 样本管理权限 |
| project_lead | project123 | 项目负责人 | 项目管理权限 |
| test_manager | test123 | 分析测试主管 | 测试管理权限 |
| lab_director | lab123 | 研究室主任 | 查看和审批权限 |
| analyst | analyst123 | 分析测试员 | 基本查看权限 |

*注：实际密码请查看 `init_db.py` 文件*

### 角色权限配置（7个角色）

1. **系统管理员** - 35个权限（全部）
2. **研究室主任** - 7个权限（查看、审批）
3. **分析测试主管** - 10个权限（测试管理）
4. **样本管理员** - 14个权限（样本全流程）
5. **项目负责人** - 8个权限（项目管理）
6. **分析测试员** - 3个权限（基本查看）
7. **质量管理员** - 8个权限（质量和偏差）

---

## 重置场景

### 场景1: 测试新功能
```bash
# 重置数据库，开始全新测试
./reset_db.sh
```

### 场景2: 数据混乱了
```bash
# 快速恢复到干净状态
./reset_db.sh
```

### 场景3: 修改了数据库模型
```bash
# 重建表结构
./reset_db.sh
```

### 场景4: 需要更新角色权限
```bash
# 1. 修改 init_roles.py 中的权限定义
# 2. 重置数据库
./reset_db.sh
```

---

## 部分重置（不删除所有数据）

如果只想重置**角色权限**，不想删除其他数据：

```bash
cd backend

# 只重新初始化角色权限（会覆盖现有角色）
python init_roles.py
```

如果只想重新分配**用户角色**：

```bash
cd backend

# 重新为用户分配角色
python migrate_user_roles.py
```

---

## 注意事项

### ⚠️ 重置会删除的内容
- ✅ 所有用户数据（会重新创建测试用户）
- ✅ 所有项目和样本数据（会重新创建测试数据）
- ✅ 所有审计日志
- ✅ 所有自定义角色和权限配置
- ✅ 所有操作记录

### ✅ 重置会保留的内容
- 无（完全重置）

### 💡 生产环境建议

**切换到生产环境时，请：**

1. **不要使用** `init_db.py --drop`
2. **使用数据库迁移工具**（如 Alembic）进行版本管理
3. **备份数据** 后再进行任何结构变更
4. **渐进式迁移** 角色权限数据

---

## 常见问题

**Q: 重置会影响正在运行的服务吗？**  
A: 不会。后端服务会自动重新连接数据库。前端页面刷新即可。

**Q: 重置需要多长时间？**  
A: 约5-10秒。

**Q: 可以保留某些数据吗？**  
A: 在测试阶段建议完全重置。如需保留数据，请手动备份数据库。

**Q: 重置后需要重启服务吗？**  
A: 不需要。服务会自动识别数据库变化。

**Q: 如何添加自定义测试数据？**  
A: 修改 `init_db.py` 文件，在相应位置添加数据创建代码。

---

## 快速参考命令

```bash
# 完整重置（推荐）
./reset_db.sh

# 仅重建数据库
python init_db.py --drop

# 仅更新角色权限
python init_roles.py

# 仅迁移用户角色
python migrate_user_roles.py

# 查看数据库状态（需要安装 psql）
psql -d lims_db -c "\dt"
```

---

## 测试建议

每次重置后，建议测试：

1. ✅ 使用不同角色登录
2. ✅ 创建新用户并分配多角色
3. ✅ 创建自定义角色
4. ✅ 测试密码验证规则
5. ✅ 编辑用户角色分配
6. ✅ 测试权限控制是否生效

---

**测试愉快！** 🎉

有任何问题随时重置数据库重新开始！

